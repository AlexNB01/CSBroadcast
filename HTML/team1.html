<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Roster Overlay â€” Team 1</title>
  <style>
    @font-face{font-family:'Rajdhani';src:url("fonts/Rajdhani/Rajdhani-Bold.ttf") format('TrueType');font-weight:700}
    @font-face{font-family:'Rajdhani';src:url("fonts/Rajdhani/Rajdhani-Regular.ttf") format('TrueType');font-weight:400}

    :root{--primary:#0f1114;--secondary:#ffffff;--team:#55aaff;--card:rgba(15,17,20,.74);--muted:#d8e7ff;--text:#ffffff;--pad-x:48px;--pad-y:28px;--gap:32px;--card-r:20px;--card-p:22px;--avatar:156px;--ico:26px;--label:20px;--value:30px;}
    html,body{margin:0;padding:0;width:1920px;height:1080px;background:rgba(0,0,0,0);overflow:hidden;font-family:'Rajdhani',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;color:var(--text)}
    *{box-sizing:border-box}
    .wrap{width:1920px; margin:0 auto; padding:var(--pad-y) var(--pad-x)}
    .title{font-size:56px;font-weight:800;line-height:1.0;margin:0 0 6px;letter-spacing:.5px;text-transform:uppercase;color:var(--secondary)}
    .subtitle{font-size:32px;font-weight:600;opacity:.96;margin:0 0 18px;min-height:1.2em;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:var(--gap)}
    .card{background:var(--card);border-radius:var(--card-r);padding:var(--card-p);text-align:center;border-top:4px solid var(--team);box-shadow:0 8px 20px rgba(0,0,0,.28)}
    .avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover;background:#fff;margin:0 auto 12px;border:3px solid rgba(255,255,255,.2)}
    .nick{font-size:38px;font-weight:800;margin-bottom:6px;text-transform:uppercase}
    .label{color:var(--muted);letter-spacing:.08em;font-size:var(--label)}
    .val{font-weight:700;font-variant-numeric:tabular-nums;font-size:var(--value)}
    .valbox{position:relative;min-height:1.4em;display:block}
    .valbox .valtext{display:inline-block;position:relative;left:50%;transform:translateX(-50%)}
    .valbox.r-good .valtext::after,.valbox.r-okay .valtext::after,.valbox.r-bad .valtext::after{content:"";position:absolute;top:50%;left:100%;transform:translate(8px,-50%);width:var(--ico);height:var(--ico);background-size:contain;background-repeat:no-repeat}
    .valbox.r-good .valtext::after{background-image:url("images/good.png")}
    .valbox.r-okay .valtext::after{background-image:url("images/okay.png")}
    .valbox.r-bad .valtext::after{background-image:url("images/bad.png")}
    .kv{display:grid;grid-template-columns:auto auto;gap:6px 36px;justify-content:center;align-items:center}
    .status{margin-top:8px;opacity:.9;font-size:22px;font-weight:700;text-transform:uppercase}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="title" class="title">Statistics</h1>
    <h2 id="subtitle" class="subtitle"></h2>
    <div id="grid" class="grid"></div>
    <div id="status" class="status"></div>
  </div>

  <script>
    const TEAM_OFFSET = 0;
    const TEAM_SIZE = 5;
    const DEFAULT_TEAM_COLOR = '#55aaff';
    const API_BASE = (location.origin === 'null' || location.protocol === 'file:') ? 'http://localhost:8787' : '';
    const API_BASES = Array.from(new Set([API_BASE, 'http://localhost:8787', '']));

    const qs = new URLSearchParams(location.search);
    const KD_GOOD  = Number(qs.get('kd_good'))  || 1.20;
    const KD_OK    = Number(qs.get('kd_ok'))    || 0.95;
    const ADR_GOOD = Number(qs.get('adr_good')) || 85;
    const ADR_OK   = Number(qs.get('adr_ok'))   || 65;
    const HS_GOOD  = Number(qs.get('hs_good'))  || 45;
    const HS_OK    = Number(qs.get('hs_ok'))    || 35;

    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const grid = document.getElementById('grid');
    const statusEl = document.getElementById('status');

    const AGENTS = ['assets/agents/agent1.png','assets/agents/agent2.png','assets/agents/agent3.png','assets/agents/agent4.png','assets/agents/agent5.png'];

    const rateKD  = v => (v==null||isNaN(v))?null:(v>=KD_GOOD?'good':(v>=KD_OK?'okay':'bad'));
    const rateADR = v => (v==null||isNaN(v))?null:(v>=ADR_GOOD?'good':(v>=ADR_OK?'okay':'bad'));
    const rateHS  = v => (v==null||isNaN(v))?null:(v>=HS_GOOD?'good':(v>=HS_OK?'okay':'bad'));
    const valOnly = t => `<span class="valtext">${t ?? '-'}</span>`;
    const boxClass = r => r ? ` valbox r-${r}` : ' valbox';
    const toNumber = (v) => { if(v==null||v==='') return null; const n=Number(String(v).replace('%','').replace(',','.').trim()); return Number.isFinite(n)?n:null; };
    const pick = (o,keys) => { for(const k of keys){ if(o && o[k]!=null && o[k] !== '') return o[k]; } return null; };
    const fromStats = (p,keys)=>pick(p?.stats||{},keys);
    const asHex = (v,fallback)=>{ const s=String(v||'').trim(); return /^#?[0-9a-fA-F]{6}$/.test(s)?(s.startsWith('#')?s:`#${s}`):fallback; };

    function applyTheme(payload){
      const g = payload?.general?.colors || {};
      const t = payload?.team1 || {};
      document.documentElement.style.setProperty('--primary', asHex(g.primary, '#0f1114'));
      document.documentElement.style.setProperty('--secondary', asHex(g.quinary || g.secondary, '#ffffff'));
      document.documentElement.style.setProperty('--muted', asHex(g.senary || '#d8e7ff', '#d8e7ff'));
      document.documentElement.style.setProperty('--team', asHex(t.color_hex, DEFAULT_TEAM_COLOR));
      document.documentElement.style.setProperty('--card', 'color-mix(in srgb, var(--primary) 74%, transparent)');
    }

    function normalizePlayer(player){
      const nickname = pick(player, ['nickname','nick','name','player_name','playerName']) || '-';
      const kills = toNumber(pick(player,['kills','kill','k']) ?? fromStats(player,['kills','kill','k']));
      const deaths = toNumber(pick(player,['deaths','death','d']) ?? fromStats(player,['deaths','death','d']));
      const kd = toNumber(pick(player,['kd','kdr','kd_ratio','k_d']) ?? fromStats(player,['kd','kdr','kd ratio','k/d']));
      const adr = toNumber(pick(player,['adr','average_damage_per_round','damage_per_round']) ?? fromStats(player,['adr','average_damage_per_round','damage per round']));
      const hsBase = toNumber(pick(player,['hs_pct','hs','headshot_pct','headshot_percentage']) ?? fromStats(player,['hs%','headshots %','headshot %','headshot_percentage']));
      const hs_pct = (hsBase != null && hsBase <= 1) ? hsBase * 100 : hsBase;
      return { nickname, kills, deaths, kd, adr, hs_pct };
    }

    function extractPlayers(payload){
      if (Array.isArray(payload?.players)) return payload.players.map(normalizePlayer);
      if (payload?.team1?.players || payload?.team2?.players) {
        const t1 = Array.isArray(payload?.team1?.players) ? payload.team1.players : [];
        const t2 = Array.isArray(payload?.team2?.players) ? payload.team2.players : [];
        return [...t1, ...t2].map(normalizePlayer);
      }
      if (Array.isArray(payload?.teams)) {
        const flat = payload.teams.flatMap(team => Array.isArray(team?.players) ? team.players : []);
        return flat.map(normalizePlayer);
      }
      return [];
    }

    function cardHTML(p, idx){
      const kd  = (p.kd  != null) ? Number(p.kd).toFixed(2) : '-';
      const adr = (p.adr != null) ? Number(p.adr).toFixed(2) : '-';
      const hs  = (p.hs_pct != null) ? Number(p.hs_pct).toFixed(0) : '-';
      return `<div class="card">
        <img class="avatar" src="${AGENTS[idx] || AGENTS[0]}" alt="">
        <div class="nick">${p.nickname ?? '-'}</div>
        <div class="kv">
          <div class="label">KILLS</div><div class="val${boxClass(null)}">${valOnly(p.kills ?? '-')}</div>
          <div class="label">DEATHS</div><div class="val${boxClass(null)}">${valOnly(p.deaths ?? '-')}</div>
          <div class="label">K/D</div><div class="val${boxClass(rateKD(Number(p.kd)))}">${valOnly(kd)}</div>
          <div class="label">ADR</div><div class="val${boxClass(rateADR(Number(p.adr)))}">${valOnly(adr)}</div>
          <div class="label">HS%</div><div class="val${boxClass(rateHS(Number(p.hs_pct)))}">${valOnly(hs)}</div>
        </div>
      </div>`;
    }

    async function fetchState(){
      const paths = ['/render', '/match.json', '/Scoreboard/Match/match.json'];
      for (const base of API_BASES) {
        for (const path of paths) {
          const url = `${base}${path}`;
          try {
            const r = await fetch(url, { cache:'no-store' });
            if (!r.ok) continue;
            const js = await r.json();
            if (js && typeof js === 'object') return js;
          } catch {}
        }
      }
      throw new Error('No usable JSON state endpoint found (/render or /match.json).');
    }

    async function refreshOnce(){
      try{
        const js = await fetchState();
        applyTheme(js);

        const statsCfg = js.statistics || {};
        const title = (statsCfg.title || 'Statistics').toString().trim() || 'Statistics';
        const subtitle = (statsCfg.subtitle || '').toString();
        titleEl.textContent = title;
        subtitleEl.textContent = subtitle;
        subtitleEl.style.display = subtitle.trim() ? 'block' : 'none';

        const allPlayers = extractPlayers(js);
        const players = allPlayers.slice(TEAM_OFFSET, TEAM_OFFSET + TEAM_SIZE);
        grid.innerHTML = '';
        if(players.length === 0){
          statusEl.textContent = 'No player stats yet. Load tournament data in tool.';
          return;
        }
        players.forEach((p, i) => grid.insertAdjacentHTML('beforeend', cardHTML(p, i)));
        statusEl.textContent = '';
      }catch(e){
        statusEl.textContent = 'Connection error: ' + e.message;
      }
    }

    refreshOnce();
    try{
      const es = new EventSource(API_BASE + '/events');
      es.addEventListener('update', refreshOnce);
      es.onmessage = refreshOnce;
    }catch{}
  </script>
</body>
</html>
