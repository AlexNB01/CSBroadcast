<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Roster Overlay</title>
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Roster Overlay</title>
  <style>
    :root{
      /* 1920-perusmitoitus */
      --wrap-w:1920px;
      --pad-x:48px;         /* sivumarginaalit */
      --pad-y:28px;         /* ylä/ala padding */
      --gap:32px;           /* korttien väli */
      --card-r:24px;
      --card-p:22px;
      --avatar:168px;       /* avatarin koko */
      --ico:27px;           /* arvioikoni */
      --h1:88px;            /* otsikko */
      --label:21px;         /* “KILLS” jne. */
      --value:30px;         /* riviarvot */
    }

    /* Perusvärit/tyylit */
    :root { --bg:#0f3d3a; --card:rgba(255,255,255,.06); --muted:#aee7dd; --text:#fff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}

    .wrap{width:var(--wrap-w); margin:0 auto; padding:var(--pad-y) var(--pad-x);}
    h1{font-size:var(--h1);line-height:1;margin:0 0 18px;font-weight:900;letter-spacing:2px}

    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:var(--gap)}
    .card{background:var(--card);border-radius:var(--card-r);padding:var(--card-p);text-align:center;backdrop-filter:blur(6px)}
    .avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover;background:#fff;margin:0 auto 12px}
    .nick{font-size:36px;font-weight:800;margin-bottom:6px}
    .label{color:var(--muted);letter-spacing:.08em;font-size:var(--label)}
    .val{font-weight:700;font-variant-numeric:tabular-nums;font-size:var(--value)}

    /* Sama rakenne kaikille arvoille → täydellinen keskitys */
    .valbox{ position:relative; min-height:1.4em; display:block; }
    .valbox .valtext{ display:inline-block; position:relative; left:50%; transform:translateX(-50%); }

    /* Ikoni pseudo-elementtinä: ei vaikuta keskitykseen */
    .valbox.r-good  .valtext::after,
    .valbox.r-okay  .valtext::after,
    .valbox.r-bad   .valtext::after{
      content:""; position:absolute; top:50%; left:100%;
      transform: translate(8px,-50%);     /* väli numeron ja ikonisisällön väliin */
      width:var(--ico); height:var(--ico); background-size:contain; background-repeat:no-repeat;
    }
    .valbox.r-good  .valtext::after{ background-image:url("images/good.png"); }
    .valbox.r-okay  .valtext::after{ background-image:url("images/okay.png"); }
    .valbox.r-bad   .valtext::after{ background-image:url("images/bad.png"); }

    .kv{display:grid;grid-template-columns:auto auto;gap:6px 36px;justify-content:center;align-items:center}
    .status{margin-top:8px;opacity:.7;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="grid" class="grid"></div>
    <div id="status" class="status"></div>
  </div>

  <script>
    // file:// -> käytä localhost-API:a
    const API_BASE = (location.origin === 'null' || location.protocol === 'file:') ? 'http://localhost:8787' : '';

    const qs = new URLSearchParams(location.search);
    const KD_GOOD  = Number(qs.get('kd_good'))  || 1.20;
    const KD_OK    = Number(qs.get('kd_ok'))    || 0.95;
    const ADR_GOOD = Number(qs.get('adr_good')) || 85;
    const ADR_OK   = Number(qs.get('adr_ok'))   || 65;
    const HS_GOOD  = Number(qs.get('hs_good'))  || 45;
    const HS_OK    = Number(qs.get('hs_ok'))    || 35;

    const grid = document.getElementById('grid');
    const statusEl = document.getElementById('status');
    const placeholder = 'https://avatars.githubusercontent.com/u/9919?s=200&v=4';

    const rateKD  = v => (v==null||isNaN(v))?null:(v>=KD_GOOD?'good':(v>=KD_OK?'okay':'bad'));
    const rateADR = v => (v==null||isNaN(v))?null:(v>=ADR_GOOD?'good':(v>=ADR_OK?'okay':'bad'));
    const rateHS  = v => (v==null||isNaN(v))?null:(v>=HS_GOOD?'good':(v>=HS_OK?'okay':'bad'));

    const valOnly = t => `<span class="valtext">${t ?? '-'}</span>`;
    const boxClass = r => r ? ` valbox r-${r}` : ' valbox';

	// Local agent avatars (override Faceit avatars)
	const AGENTS = [
	  'images/agent1.png',
	  'images/agent2.png',
	  'images/agent3.png',
	  'images/agent4.png',
	  'images/agent5.png',
	];

    function cardHTML(p, idx){
      const kd  = (p.kd  != null) ? Number(p.kd).toFixed(2) : '-';
      const adr = (p.adr != null) ? Number(p.adr).toFixed(2) : '-';
      const hs  = (p.hs_pct != null) ? Number(p.hs_pct).toFixed(0) : '-';
	  
	  const avatarSrc = AGENTS[idx] || AGENTS[0];

      return `<div class="card">
        <img class="avatar" src="${avatarSrc}" alt="">
        <div class="nick">${p.nickname ?? '-'}</div>
        <div class="kv">
          <div class="label">KILLS</div><div class="val${boxClass(null)}">${valOnly(p.kills ?? '-')}</div>
          <div class="label">DEATHS</div><div class="val${boxClass(null)}">${valOnly(p.deaths ?? '-')}</div>
          <div class="label">K/D</div><div class="val${boxClass(rateKD(Number(p.kd)))}">${valOnly(kd)}</div>
          <div class="label">ADR</div><div class="val${boxClass(rateADR(Number(p.adr)))}">${valOnly(adr)}</div>
          <div class="label">HS%</div><div class="val${boxClass(rateHS(Number(p.hs_pct)))}">${valOnly(hs)}</div>
        </div>
      </div>`;
    }

    async function refreshOnce(){
      try{
        const r = await fetch(API_BASE + '/render', { cache:'no-store' });
        if(!r.ok) throw new Error(await r.text());
        const js = await r.json();
        const players = (js.players || []).slice(0,5);
        grid.innerHTML = '';
        if(players.length === 0){
          statusEl.textContent = 'Waiting for config… (press Load in GUI)';
          return;
        }
        players.forEach((p, i) => grid.insertAdjacentHTML('beforeend', cardHTML(p, i)));
        statusEl.textContent = '';
      }catch(e){
        statusEl.textContent = 'Connection error: ' + e.message;
      }
    }

    // 1) yksi haku heti
    refreshOnce();

    // 2) SSE: päivitys vain kun GUI lähettää /config
    try{
      const es = new EventSource(API_BASE + '/events');
      es.addEventListener('update', () => { refreshOnce(); });
    }catch(e){
      statusEl.textContent = 'SSE not supported in this environment.';
    }
  </script>
</body>
</html>
