<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>Maps</title>

<style>
  @font-face{font-family:'Rajdhani';src:url("fonts/Rajdhani/Rajdhani-Bold.ttf") format('TrueType');font-weight:bold}
  @font-face{font-family:'Rajdhani';src:url("fonts/Rajdhani/Rajdhani-Regular.ttf") format('TrueType');font-weight:normal}

  html,body{
    margin:0; padding:0; width:1920px; height:1080px; overflow:hidden;
    font-family:'Rajdhani',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
    font-weight:800; text-transform:uppercase;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  :root{
    --primary:#0f1114; --secondary:#ffffff; --tertiary:#3a3a90; --quaternary:#006ea1;
    --t1:#27AAE1; --t2:#C80013;
    --t1-rgb:39,170,225; --t2-rgb:200,0,19;
    --radius:12px; --gap:16px;
    --shadow:0 8px 22px rgba(0,0,0,.25);
    --sb-h:100px;
  }

  .scoreboardwrapper{
    position:absolute; left:0; top:0; width:1920px; height:var(--sb-h);
    display:flex; align-items:center; justify-content:center; pointer-events:none;
  }
  .scorebar{
    width:1920px; height:var(--sb-h);
    background:var(--primary); color:var(--tertiary);
    position:relative;
    display:grid; grid-template-columns:minmax(0,1fr) auto minmax(0,1fr);
    align-items:center; padding:0 16px;
  }
  .scorebar::before, .scorebar::after{ content:""; position:absolute; top:0; bottom:0; width:8px; }
  .scorebar::before{ left:0;  background:var(--t1); }
  .scorebar::after { right:0; background:var(--t2); }

  .team{ height:100%; display:flex; align-items:center; gap:16px; }
  .team2{ flex-direction:row-reverse; }
  .teamlogo{ width:90px; height:90%; background:center/contain no-repeat; }
  .teamname{
    flex:1 1 auto; font-weight:900; font-size:68px; letter-spacing:.5px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--secondary); text-align:center;
  }
  .scorebox{ flex:0 0 105px; height:100%; display:flex; align-items:center; justify-content:center; background:var(--quaternary);}
  .teamscore{ font-size:68px; font-weight:900; line-height:1; color:#fff; }
  .vs{ height:100%; display:flex; align-items:center; justify-content:center; padding:0 30px; background:var(--tertiary); color:var(--primary); font-size:68px; font-weight:900; }

.maps-area{
  position:absolute; top:var(--sb-h); bottom:100px; left:0px; right:0px;
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:1fr;
  justify-content:stretch;
  align-items:start;
  gap:0;
}
  .map-wrap{
    display:flex; flex-direction:column; align-items:stretch;
    min-width:0;
  }

  .map-card{
	height:775px;
    position:relative; flex:1 1 auto;
    background:#222 center/cover no-repeat;
    box-shadow:var(--shadow);
    overflow:hidden; isolation:isolate;
    display:flex; align-items:center; justify-content:center;
  }
  
.map-card .map-score{
  position:absolute;
  left:50%;
  top:10%;
  transform:translateX(-50%);
  display:flex; align-items:center; justify-content:center; gap:18px;
  padding:6px 18px;
  font:900 72px/1 'Rajdhani', sans-serif;
  color:#fff;
  text-shadow:0 4px 12px rgba(0,0,0,.45);
  z-index:4;
  background:rgba(0,0,0,.25);
  border-radius:12px;
  backdrop-filter:blur(2px);
}

.map-card .map-score .score{ min-width:90px; text-align:center; }
.map-card .map-score .score-sep{
  width:4px; height:0.9em;
  background:rgba(255,255,255,.9);
  border-radius:2px;
  box-shadow:0 2px 8px rgba(0,0,0,.25);
}

.placeholder{
  width:55%;
  height:70%;
  max-width:360px;
  max-height:70%;
  background:center/contain no-repeat;
  filter:drop-shadow(0 8px 18px rgba(0,0,0,.5));
  opacity:.95;
}

  .map-card.winner-t1::before,
  .map-card.winner-t2::before{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background:linear-gradient(0deg,
      rgba(var(--winner-rgb), .75) 0%,
      rgba(var(--winner-rgb), .55) 55%,
      rgba(var(--winner-rgb), 0) 100%);
    pointer-events:none;
  }
  .winner-center{ position:absolute; inset:0; display:flex; justify-content:center; align-items:center; pointer-events:none; }
  .winner-center img{ width:60%; max-width:300px; max-height:70%; object-fit:contain; opacity:.95; filter:drop-shadow(0 8px 18px rgba(0,0,0,.55)); }

.map-bans{
  position:absolute; left:0; right:0; bottom:0;
  display:grid; grid-template-columns:1fr auto 1fr;
  align-items:end; justify-items:center;
  padding:10px 12px;
  background:transparent;
}

.ban-wrap{
  display:flex; flex-direction:column; align-items:center; gap:6px;
}

.ban-label{
  font:900 18px/20px 'Rajdhani', sans-serif;
  letter-spacing:.6px; color:#111;
  background:#fff; padding:2px 10px;
  border-radius:6px;
}

.ban{
  width:100px; height:100px;
  background:center/cover no-repeat;
  border-radius:10px;
  box-shadow:0 6px 14px rgba(0,0,0,.35);
  background-color:#ffffff;
}

  .map-caption{
    margin-top:0px; padding:10px 16px;
    background:rgba(0,0,0,.70); color:#fff; text-align:center;
    font-size:40px; font-weight:900; letter-spacing:.4px;
  }
  .map-card.waiting { background: var(--tertiary) center/cover no-repeat; }
.map-card.future-map { filter: grayscale(100%); }
.mode-icon{ width:100px; height:100px; background:center/contain no-repeat; opacity:.95; }
#status{
  position:absolute;
  left:50%; bottom:20px; transform:translateX(-50%);
  display:none;

  max-width:80vw;
  padding:14px 28px;
  line-height:1.2;

  background:var(--primary);
  border-left:8px solid var(--tertiary);
  border-right:8px solid var(--tertiary);
  border-radius:12px;
  box-shadow:0 8px 22px rgba(0,0,0,.25);

  font-size:40px; font-weight:900; letter-spacing:.6px;
  color:var(--secondary);
  text-align:center; text-transform:uppercase;

  white-space:pre-wrap; word-break:break-word;
}




.map-card.waiting{ background: var(--tertiary) center/cover no-repeat; }
</style>
</head>
<body>
<div class="scoreboardwrapper">
  <div class="scorebar">
    <div class="team team1">
      <div class="teamlogo" id="t1logo"></div>
      <div class="teamname" id="t1name">TEAM 1</div>
      <div class="scorebox" id="t1scorebox"><span class="teamscore" id="t1score">0</span></div>
    </div>
    <div class="vs">VS</div>
    <div class="team team2">
      <div class="teamlogo" id="t2logo"></div>
      <div class="teamname" id="t2name">TEAM 2</div>
      <div class="scorebox" id="t2scorebox"><span class="teamscore" id="t2score">0</span></div>
    </div>
  </div>
</div>
<div class="maps-area" id="maps"></div>
<div id="status"></div>
<script>
const ROOT="..";
const SB=ROOT+"/Scoreboard", MATCH=SB+"/Match", GENERAL=SB+"/General", HEROES=SB+"/Heroes", MAPS=SB+"/Maps";

async function read(p){ try{ const r=await fetch(p+"?_="+Date.now()); return r.ok?await r.text():""; }catch{ return ""; } }
async function readJSON(p){ try{ const r=await fetch(p+"?_="+Date.now()); return r.ok?await r.json():{}; }catch{ return {}; } }
async function ok(p){ try{ const r=await fetch(p+"?_="+Date.now(),{method:"HEAD"}); return r.ok; }catch{ return false; } }

const slug = (s)=> (s||"").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase()
  .replace(/[^a-z0-9]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");
const hex=s=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test((s||"").trim())?(s||"").trim():null;
function hexToRgb(hexStr){ const m=(hexStr||"").trim().replace(/^#/,'').toLowerCase();
  const s=m.length===3?m.split('').map(c=>c+c).join(''):m; const n=parseInt(s,16);
  if(isNaN(n)||s.length!==6) return null; return [(n>>16)&255,(n>>8)&255,n&255]; }
const setBg=(el,url)=>el&&(el.style.backgroundImage=`url('${url}?_=${Date.now()}')`);
const normRelPath=p=>(p||"").replace(/^\/+/ ,"").replace(/\\/g,"/");
const resolveMapImagePath=(meta,mapName)=>{
  const imageRef = normRelPath(meta?.image || "");
  if(imageRef){
    if(imageRef.toLowerCase().startsWith("scoreboard/")) return `${ROOT}/${imageRef}`;
    if(imageRef.toLowerCase().startsWith("maps/")) return `${SB}/${imageRef}`;
    return `${MAPS}/${imageRef.split('/').pop()}`;
  }
  return `${MAPS}/${slug(meta?.slug || mapName)}.png`;
};
const normalizePick=(pickRaw)=>{
  const pick=((pickRaw||"")+"").trim().toUpperCase();
  if(pick==="TEAM 1") return "T1";
  if(pick==="TEAM 2") return "T2";
  return pick;
};

function adjustMapsBottom(){
  const statusEl = document.getElementById("status");
  const mapsEl   = document.getElementById("maps");
  if (!mapsEl) return;

  if (statusEl.style.display === "none") {
    mapsEl.style.bottom = "20px";
  } else {
    const h = statusEl.getBoundingClientRect().height;
    mapsEl.style.bottom = (h + 40) + "px";
  }
}

async function upStatus(){
  const el  = document.getElementById("status");
  const txt = (await read(MATCH + "/status.txt")).trim();
  el.textContent = txt;
  el.style.display = txt ? "block" : "none";
  adjustMapsBottom();
}

async function resolveOverlayLogo(){
  const cands = [
    GENERAL + "/OverlayLogo.png",
  ];
  for (const p of cands) {
    if (await ok(p)) return p;
  }
  return null;
}

let OVERLAY_LOGO = null;
let _prevHeaderSig = null;

async function applyColors(){
  const kv={};
  (await read(GENERAL+"/colors.txt")).split(/\r?\n/).forEach(l=>{
    const m=l.match(/^\s*([^=#]+)\s*=\s*(.+?)\s*$/); if(m) kv[m[1].trim()]=m[2].trim();
  });
  const p=hex(kv.primary)||"#0f1114", s=hex(kv.secondary)||"#ffffff", t=hex(kv.tertiary)||"#3a3a90", q=hex(kv.quaternary)||"#006ea1";
  document.documentElement.style.setProperty("--primary",p);
  document.documentElement.style.setProperty("--secondary",s);
  document.documentElement.style.setProperty("--tertiary",t);
  document.documentElement.style.setProperty("--quaternary",q);
}

async function upT1(){
  document.getElementById("t1name").textContent=((await read(MATCH+"/T1Name.txt")).trim()||"TEAM 1").toUpperCase();
  document.getElementById("t1score").textContent=(await read(MATCH+"/T1Score.txt")).trim()||"0";
  const c = hex((await read(MATCH+"/T1Color.txt")).trim()) || "#27AAE1";
  document.documentElement.style.setProperty("--t1", c);
  const rgb = hexToRgb(c) || [39,170,225];
  document.documentElement.style.setProperty("--t1-rgb", rgb.join(","));
  if(await ok(MATCH+"/T1Logo.png")) setBg(document.getElementById("t1logo"), MATCH+"/T1Logo.png");
  else document.getElementById("t1logo").style.backgroundImage="none";
}
async function upT2(){
  document.getElementById("t2name").textContent=((await read(MATCH+"/T2Name.txt")).trim()||"TEAM 2").toUpperCase();
  document.getElementById("t2score").textContent=(await read(MATCH+"/T2Score.txt")).trim()||"0";
  const c = hex((await read(MATCH+"/T2Color.txt")).trim()) || "#C80013";
  document.documentElement.style.setProperty("--t2", c);
  const rgb = hexToRgb(c) || [200,0,19];
  document.documentElement.style.setProperty("--t2-rgb", rgb.join(","));
  if(await ok(MATCH+"/T2Logo.png")) setBg(document.getElementById("t2logo"), MATCH+"/T2Logo.png");
  else document.getElementById("t2logo").style.backgroundImage="none";
}

let _prevSig = null;

async function renderMaps(){
  const [mapsManifest, modesManifest, state] = await Promise.all([
    readJSON(SB + "/Maps/index.json"),
    readJSON(SB + "/Gametypes/index.json"),
    readJSON(MATCH + "/match.json"),
  ]);
  const bySlug = (arr=[]) => Object.fromEntries((arr||[]).map(x => [ (x.slug||"").toLowerCase(), x ]));
  const mapsBySlug  = bySlug((mapsManifest || {}).maps || []);
  const modesByName = Object.fromEntries(((modesManifest || {}).modes || []).map(m => [ (m.name||"").toLowerCase(), (m.slug||"").toLowerCase() ]));
  const root = document.getElementById("maps");

  const maps = (state.maps || []).filter(m => (m.map || "").trim());
  const undecided = maps
    .map((m, idx) => ({ idx, pick: normalizePick(m.pick) }))
    .filter(x => !(x.pick === "T1" || x.pick === "T2"));
  const deciderIdx = undecided.length ? undecided[undecided.length - 1].idx : -1;

  const playable = maps
    .map((m, idx) => {
      const pick = normalizePick(m.pick);
      const action = idx === deciderIdx ? "DECIDER" : (pick === "T1" || pick === "T2" ? "PICK" : "BAN");
      return {
        idx: Number(m.index) || (idx + 1),
        name: (m.map || "").trim(),
        t1: Number(m.t1) || 0,
        t2: Number(m.t2) || 0,
        completed: !!m.completed,
        winner: ((m.winner || "") + "").trim().toLowerCase(),
        mode: (m.mode || "").trim(),
        action,
      };
    })
    .filter(m => m.action !== "BAN");

  const currentPlayableIdx = playable.findIndex(m => !m.completed);

  const sig = JSON.stringify(playable);
  if(sig === _prevSig) return;
  _prevSig = sig;

  root.innerHTML = "";
  if(!OVERLAY_LOGO) OVERLAY_LOGO = await resolveOverlayLogo();
  if (!playable.length) return;

  root.style.gridTemplateColumns = `repeat(${playable.length}, minmax(0, 1fr))`;

  for (const [playableIdx, m] of playable.entries()){
    const wrap = document.createElement("div");
    wrap.className = "map-wrap";

    const card = document.createElement("div");
    card.className = "map-card";
    if (currentPlayableIdx >= 0 && playableIdx > currentPlayableIdx) {
      card.classList.add("future-map");
    }

    let bgSet = false;
    if(m.name){
      const meta = mapsBySlug[slug(m.name)] || {};
      const mapPath = resolveMapImagePath(meta, m.name);
      if(await ok(mapPath)){
        card.style.backgroundImage = `url('${mapPath}?_=${Date.now()}')`;
        bgSet = true;
      }
    }
    if(!m.name || !bgSet){
      card.classList.add("waiting");
      if(OVERLAY_LOGO){
        const ph = document.createElement("div");
        ph.className = "placeholder";
        ph.style.backgroundImage = `url('${OVERLAY_LOGO}?_=${Date.now()}')`;
        card.appendChild(ph);
      }
    }

    const win = (m.winner === "t1" || m.winner === "t2")
      ? m.winner
      : (m.completed ? (m.t1 > m.t2 ? "t1" : (m.t2 > m.t1 ? "t2" : "")) : "");

    if(win){
      const rgb = getComputedStyle(document.documentElement).getPropertyValue(win==="t1" ? "--t1-rgb" : "--t2-rgb").trim();
      card.style.setProperty("--winner-rgb", rgb || (win==="t1"?"39,170,225":"200,0,19"));
      card.classList.add(`winner-${win}`);

      const center = document.createElement("div");
      center.className="winner-center";
      const img=document.createElement("img");
      img.src = `${MATCH}/${win.toUpperCase()}Logo.png?_=${Date.now()}`;
      img.alt = win.toUpperCase();
      center.appendChild(img);
      card.appendChild(center);
    }

    const shouldShowScore = !!m.name && (m.t1 > 0 || m.t2 > 0 || m.completed);
    if (shouldShowScore) {
      const scoreDiv = document.createElement("div");
      scoreDiv.className = "map-score";
      scoreDiv.innerHTML = `
        <span class="score s1">${m.t1}</span>
        <span class="score-sep"></span>
        <span class="score s2">${m.t2}</span>
      `;
      card.appendChild(scoreDiv);
    }

    const modeDiv = document.createElement("div");
    modeDiv.className = "mode-icon";
    let modeSlug = "";
    if (m.mode) {
      modeSlug = slug(m.mode);
    } else if (m.name) {
      const meta = mapsBySlug[slug(m.name)];
      const modeName = (meta?.mode || "").toLowerCase();
      modeSlug = modesByName[modeName] || modeName;
    }
    if (modeSlug) {
      const mfile = `${SB}/Gametypes/${modeSlug}.png`;
      if (await ok(mfile)) {
        modeDiv.style.backgroundImage = `url('${mfile}?_=${Date.now()}')`;
        const modeWrap = document.createElement("div");
        modeWrap.className = "map-bans";
        modeWrap.appendChild(document.createElement("div"));
        modeWrap.appendChild(modeDiv);
        modeWrap.appendChild(document.createElement("div"));
        card.appendChild(modeWrap);
      }
    }

    const cap = document.createElement("div");
    cap.className = "map-caption";
    cap.textContent = m.name || `MAP ${m.idx}`;

    wrap.appendChild(card);
    wrap.appendChild(cap);
    root.appendChild(wrap);
  }
}


async function refreshHeader(){
  const t1name = ((await read(MATCH+"/T1Name.txt")).trim()||"TEAM 1").toUpperCase();
  const t2name = ((await read(MATCH+"/T2Name.txt")).trim()||"TEAM 2").toUpperCase();
  const t1score = (await read(MATCH+"/T1Score.txt")).trim()||"0";
  const t2score = (await read(MATCH+"/T2Score.txt")).trim()||"0";
  const t1color = (await read(MATCH+"/T1Color.txt")).trim()||"#27AAE1";
  const t2color = (await read(MATCH+"/T2Color.txt")).trim()||"#C80013";
  const haveT1Logo = await ok(MATCH+"/T1Logo.png");
  const haveT2Logo = await ok(MATCH+"/T2Logo.png");

  const sig = JSON.stringify({t1name,t2name,t1score,t2score,t1color,t2color,haveT1Logo,haveT2Logo});
  if(sig === _prevHeaderSig) return;
  _prevHeaderSig = sig;

  document.getElementById("t1name").textContent = t1name;
  document.getElementById("t2name").textContent = t2name;
  document.getElementById("t1score").textContent = t1score;
  document.getElementById("t2score").textContent = t2score;

  const t1rgb = hexToRgb(t1color) || [39,170,225];
  const t2rgb = hexToRgb(t2color) || [200,0,19];
  document.documentElement.style.setProperty("--t1", t1color);
  document.documentElement.style.setProperty("--t2", t2color);
  document.documentElement.style.setProperty("--t1-rgb", t1rgb.join(","));
  document.documentElement.style.setProperty("--t2-rgb", t2rgb.join(","));

  const t1logo = document.getElementById("t1logo");
  const t2logo = document.getElementById("t2logo");
  t1logo.style.backgroundImage = haveT1Logo ? `url('${MATCH}/T1Logo.png?_=${Date.now()}')` : "none";
  t2logo.style.backgroundImage = haveT2Logo ? `url('${MATCH}/T2Logo.png?_=${Date.now()}')` : "none";
}

async function tick(){
  try{
	await applyColors();
    await refreshHeader();
    await renderMaps();
	await upStatus();
  }finally{
    setTimeout(tick, 1000);
  }
}
tick();
</script>
</body>
</html>
