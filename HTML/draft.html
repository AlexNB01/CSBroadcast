<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>Draft</title>

<style>
  /* ==== Fonts ==== */
  @font-face{font-family:'Rajdhani';src:url("fonts/Rajdhani/Rajdhani-Bold.ttf") format('TrueType');font-weight:bold}
  @font-face{font-family:'Rajdhani';src:url("fonts/Rajdhani/Rajdhani-Regular.ttf") format('TrueType');font-weight:normal}

  /* ==== Base ==== */
	html,body{
	  margin:0; padding:0; width:1920px; height:1080px; overflow:hidden;
	  font-family:'Rajdhani',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
	  font-weight:800; text-transform:uppercase;
	  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
	}
  :root{
    --primary:#0f1114; --secondary:#ffffff; --tertiary:#3a3a90; --quaternary:#006ea1;
    --t1:#27AAE1; --t2:#C80013;
    --radius:12px; --radius-sm:8px; --gap:16px;
    --shadow:0 8px 22px rgba(0,0,0,.25);
    --sb-w:1620px; --sb-h:100px;
  }

  /* ==== SCOREBOARD ==== */
.scoreboardwrapper{
  position:absolute; left:0; top:0; width:1920px; height:var(--sb-h);
  display:flex; align-items:center; justify-content:center; pointer-events:none;
}

.scorebar{
  width:1920px; height:var(--sb-h);
  background:var(--primary); color:var(--tertiary);
  border-radius:0;                 
  box-shadow:none;                 
  position:relative;
  display:grid; grid-template-columns:minmax(0,1fr) auto minmax(0,1fr);
  align-items:center; padding:0 16px;
}
.scorebar::before, .scorebar::after{
  content:""; position:absolute; top:0; bottom:0; width:8px;
}
.scorebar::before{ left:0;  background:var(--t1); border-radius:0; }
.scorebar::after { right:0; background:var(--t2); border-radius:0; }

  .team{ height:100%; display:flex; align-items:center; gap:16px; }
  .team2{ flex-direction:row-reverse; }
  .teamlogo{
    width:90px; height:90%; border-radius:var(--radius-sm);
    background-size:contain; background-position:center; background-repeat:no-repeat;
  }
  .teamname{
    flex:1 1 auto; font-weight:900; font-size:68px; letter-spacing:.5px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--secondary); text-align:center;
  }
  .scorebox{
    flex:0 0 105px; height:100%; display:flex; align-items:center; justify-content:center;
    background:var(--quaternary);
  }
  .teamscore{ font-size:68px; font-weight:900; line-height:1; color:#ffffff; }
  .vs{
    height:100%; display:flex; align-items:center; justify-content:center;
    padding:0 30px; background:var(--tertiary); color:var(--primary);
    font-size:68px; font-weight:900;
  }

  /* ==== DRAFT ==== */
.draft-area{
  position:absolute; left:0; top:var(--sb-h);
  width:1920px; bottom:20px;
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:minmax(0,1fr);
  gap:14px; padding:18px 24px 0; box-sizing:border-box;
  margin-top:20px;
}

.draft-col{
  display:flex;
  flex-direction:column;
  min-width:0;
}

.map-card{
  position:relative;
  flex:1 1 auto;
  min-height:0;
  border-radius:0;
  background-size:cover;
  background-position:center;
  box-shadow:var(--shadow);
  overflow:hidden;                 
  background-clip:padding-box;     
  isolation:isolate;               
}

.map-card::after{
  content:"";
  position:absolute;
  inset:0;
  background:rgba(45, 17, 98, .45);
  pointer-events:none;
}

.map-card.pick::after{ background:rgba(58, 58, 144, .35); }
.map-card.decider::after{ background:rgba(15, 17, 20, .15); }

.map-card.winner-t1::before,
.map-card.winner-t2::before{
  content:"";
  position:absolute; inset:0;
  border-radius:inherit;                 
  background: linear-gradient(
    0deg,
    rgba(var(--winner-rgb), .75) 0%,
    rgba(var(--winner-rgb), .55) 55%,
    rgba(var(--winner-rgb), 0) 100%
  );
  pointer-events:none;
}

.winner-center{ position:absolute; inset:0; border-radius:inherit;
  display:flex; align-items:center; justify-content:center; pointer-events:none;
}

.winner-center{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    pointer-events:none;
    z-index:2;
  }
  .winner-center img{
    width:60%; max-width:320px; max-height:70%; margin-bottom:50px;
    object-fit:contain; filter:drop-shadow(0 8px 18px rgba(0,0,0,.55));
    opacity:.95;
  }

.action-logo{
  width:56%;
  max-width:260px;
  max-height:52%;
  object-fit:contain;
  filter:drop-shadow(0 10px 20px rgba(0,0,0,.6));
  opacity:.96;
  z-index:2;
}

.card-meta{
  display:flex;
  flex-direction:column;
  z-index:3;
}

.action-tag,
.map-name{
  text-align:center;
  font-weight:900;
  letter-spacing:.8px;
  line-height:1;
}

.action-tag{
  color:#ff315f;
  background:#24195c;
  font-size:48px;
  padding:10px 10px;
}

.map-name{
  color:#a4a4b3;
  background:#f0f0f2;
  font-size:52px;
  padding:10px 10px;
}

.map-card.pick + .card-meta .action-tag,
.map-card.decider + .card-meta .action-tag{
  color:#f5f6ff;
}

  .empty-note{ grid-column:1 / -1; color:#ddd; font-size:22px; opacity:.9; margin:16px 8px; }
  
.map-card.winner-t1 .map-name,
.map-card.winner-t2 .map-name {
  background: none !important;
  text-shadow: 0 0 8px rgba(0,0,0,.7);
}
.map-card.disabled { filter: grayscale(60%) brightness(60%); }

.corner-ban{
  position:absolute;
  bottom:22px;
  width:220px; height:220px;
  display:flex; align-items:flex-end; justify-content:center;
  pointer-events:none; z-index:50;
}
.corner-ban.left  { left:22px; }
.corner-ban.right { right:22px; }

.corner-ring{
  position:absolute; inset:0;
  border-radius:24px;
  background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.65));
  border:4px solid rgba(255,255,255,.12);
  box-shadow:0 12px 28px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.06);
}

.corner-ring.t1{ outline:4px solid var(--t1); outline-offset:-6px; }
.corner-ring.t2{ outline:4px solid var(--t2); outline-offset:-6px; }

.corner-hero{
  position:absolute; inset:10px;
  border-radius:18px;
  background:#ffffff center/contain no-repeat;
  filter:drop-shadow(0 12px 24px rgba(0,0,0,.45));
}

.corner-chip{
  position:relative; bottom:10px;
  max-width:92%;
  padding:8px 12px; border-radius:999px;
  color:#fff; font-size:18px; font-weight:900; letter-spacing:.4px;
  background:rgba(20,20,20,.55);
  border:1px solid rgba(255,255,255,.12);
  backdrop-filter:blur(6px);
  text-shadow:0 2px 6px rgba(0,0,0,.6);
}

.corner-chip.t1 { box-shadow:0 0 0 2px var(--t1); }
.corner-chip.t2 { box-shadow:0 0 0 2px var(--t2); }
.status-wrapper{
  position:absolute; left:0; bottom:6%; width:100%;
  display:flex; align-items:center; justify-content:center;
}

.statusiso{
  background:var(--primary);
  border-left:8px solid var(--tertiary);
  border-right:8px solid var(--tertiary);
  border-radius:12px;
  box-shadow:0 8px 22px rgba(0,0,0,.25);
  display:flex; align-items:center; justify-content:center;
  min-width:400px; max-width:75%;
  height:70px;
}

.status{
  display:flex; align-items:center; justify-content:center;
  padding:0 24px;
}

.statusname{
  font-size:40px; letter-spacing:.6px;
  color:var(--secondary);
  text-transform:uppercase;
  font-weight:800;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}


</style>
</head>
<body>

<!-- SCOREBOARD -->
<div class="scoreboardwrapper">
  <div class="scorebar">
    <div class="team team1">
      <div class="teamlogo" id="t1logo"></div>
      <div class="teamname" id="t1name">TEAM 1</div>
      <div class="scorebox" id="t1scorebox"><span class="teamscore" id="t1score">0</span></div>
    </div>
    <div class="vs">VS</div>
    <div class="team team2">
      <div class="teamlogo" id="t2logo"></div>
      <div class="teamname" id="t2name">TEAM 2</div>
      <div class="scorebox" id="t2scorebox"><span class="teamscore" id="t2score">0</span></div>
    </div>
  </div>
</div>

<!-- DRAFT COLUMNS -->
<div class="draft-area" id="draftArea"></div>
<!-- Corner bans -->
<div id="banLeft"  class="corner-ban left"  aria-hidden="true"></div>
<div id="banRight" class="corner-ban right" aria-hidden="true"></div>
<div class="status-wrapper">
  <div class="statusiso" id="status-bar" style="display:none">
    <div class="status">
      <span class="statusname" id="status-text"></span>
    </div>
  </div>
</div>



<script>
const ROOT="..", SB=ROOT+"/Scoreboard", MATCH=SB+"/Match", GENERAL=SB+"/General";
async function read(p){ try{ const r=await fetch(p+"?_="+Date.now()); return r.ok?await r.text():""; }catch{ return ""; } }
async function readJSON(p){ try{ const r=await fetch(p+"?_="+Date.now()); return r.ok?await r.json():{}; }catch{ return {}; } }
async function ok(p){ try{ const r=await fetch(p+"?_="+Date.now(),{method:"HEAD"}); return r.ok; }catch{ return false; } }
const hex=s=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test((s||"").trim())?(s||"").trim():null;
const setBg=(el,url)=>el&&(el.style.backgroundImage=`url('${url}?_=${Date.now()}')`);
const bySlug=list=>{const m={};(list||[]).forEach(x=>x?.slug&&(m[x.slug]=x));return m;};
const nameToSlug=n=> (n||"").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase()
  .replace(/[^a-z0-9]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");
const normRelPath=p=>(p||"").replace(/^\/+/,"").replace(/\\/g,"/");
const resolveMapImagePath=(meta,mapName)=>{
  const imageRef = normRelPath(meta?.image || "");
  if(imageRef){
    if(imageRef.toLowerCase().startsWith("scoreboard/")) return `${ROOT}/${imageRef}`;
    if(imageRef.toLowerCase().startsWith("maps/")) return `${SB}/${imageRef}`;
    return `${SB}/Maps/${imageRef.split('/').pop()}`;
  }
  const slug = (meta?.slug || nameToSlug(mapName));
  return `${SB}/Maps/${slug}.jpg`;
};
function hexToRgb(hexStr){
  const m=(hexStr||"").trim().replace(/^#/,'').toLowerCase();
  const s=m.length===3?m.split('').map(c=>c+c).join(''):m;
  const n=parseInt(s,16); if(isNaN(n)||s.length!==6) return null;
  return [(n>>16)&255,(n>>8)&255,n&255];
}

const heroSlug = (name) =>
  (name||"").normalize("NFKD").replace(/[\u0300-\u036f]/g,"")
    .toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");

async function readMapBansByIndex(n){
  if(!n || n < 1) return {t1_ban:"", t2_ban:""};
  const path = `${MATCH}/Map${n}.txt`;
  try{
    const r = await fetch(path + "?_=" + Date.now());
    if(!r.ok) return {t1_ban:"", t2_ban:""};
    const kv = {};
    (await r.text()).split(/\r?\n/).forEach(line=>{
      const m = line.match(/^\s*([^=#]+)\s*=\s*(.+?)\s*$/);
      if(m) kv[m[1].trim()] = m[2].trim();
    });
    return {
      t1_ban: (kv.T1Ban || "").trim(),
      t2_ban: (kv.T2Ban || "").trim(),
    };
  }catch{ return {t1_ban:"", t2_ban:""}; }
}


function cornerBanHTML(side, hero){
  if(!hero) return "";
  const slug = heroSlug(hero);
  const img  = slug ? `${SB}/Heroes/${slug}.png` : "";
  return `
    <div class="corner-ring ${side}"></div>
    <div class="corner-hero" style="${img ? `background-image:url('${img}')` : ""}"></div>
  `;
}

let _prevCorner = { b1: null, b2: null };

async function upStatusText(){
  const txt = await read(MATCH + "/status.txt");
  const s = (txt || "").trim();
  const bar = document.getElementById("status-bar");
  const span = document.getElementById("status-text");
  if (!bar || !span) return;

  if (s){
    span.textContent = s.toUpperCase();
    bar.style.display = "flex";
  } else {
    span.textContent = "";
    bar.style.display = "none";
  }
}

async function renderCornerBans(state){
  let ci = Number(state.current || 0);
  if(!ci){
    const ctxt = (await read(MATCH + "/CurrentMap.txt")).trim();
    ci = parseInt(ctxt, 10) || 0;
  }
  const idx = ci > 0 ? (ci - 1) : -1;

  let b1 = "", b2 = "";
  const cur = (idx >= 0 && (state.maps||[])[idx]) ? state.maps[idx] : null;
  if(cur){
    b1 = (cur.t1_ban || "").trim();
    b2 = (cur.t2_ban || "").trim();
  }

  if(!b1 && !b2 && ci > 0){
    const fb = await readMapBansByIndex(ci);
    b1 = fb.t1_ban || "";
    b2 = fb.t2_ban || "";
  }

  if(b1 !== _prevCorner.b1){
    const el = document.getElementById("banLeft");
    el.innerHTML   = b1 ? cornerBanHTML("t1", b1) : "";
    el.style.display = b1 ? "block" : "none";
    _prevCorner.b1 = b1;
  }
  if(b2 !== _prevCorner.b2){
    const el = document.getElementById("banRight");
    el.innerHTML   = b2 ? cornerBanHTML("t2", b2) : "";
    el.style.display = b2 ? "block" : "none";
    _prevCorner.b2 = b2;
  }
}


/* ----- Colours ----- */
async function applyColors(){
  const kv={};
  (await read(GENERAL+"/colors.txt")).split(/\r?\n/).forEach(l=>{
    const m=l.match(/^\s*([^=#]+)\s*=\s*(.+?)\s*$/); if(m) kv[m[1].trim()]=m[2].trim();
  });
  const p=hex(kv.primary)||"#0f1114", s=hex(kv.secondary)||"#ffffff", t=hex(kv.tertiary)||"#3a3a90", q=hex(kv.quaternary)||"#006ea1";
  document.documentElement.style.setProperty("--primary",p);
  document.documentElement.style.setProperty("--secondary",s);
  document.documentElement.style.setProperty("--tertiary",t);
  document.documentElement.style.setProperty("--quaternary",q);
}

/* ----- Teams ----- */
async function upT1(){
  document.getElementById("t1name").textContent=((await read(MATCH+"/T1Name.txt")).trim()||"TEAM 1").toUpperCase();
  document.getElementById("t1score").textContent=(await read(MATCH+"/T1Score.txt")).trim()||"0";
  const c = hex((await read(MATCH+"/T1Color.txt")).trim()) || "#27AAE1";
  document.documentElement.style.setProperty("--t1", c);
  const rgb = hexToRgb(c) || [39,170,225];
  document.documentElement.style.setProperty("--t1-rgb", rgb.join(","));
  if(await ok(MATCH+"/T1Logo.png")) setBg(document.getElementById("t1logo"), MATCH+"/T1Logo.png");
  else document.getElementById("t1logo").style.backgroundImage="none";
}
async function upT2(){
  document.getElementById("t2name").textContent=((await read(MATCH+"/T2Name.txt")).trim()||"TEAM 2").toUpperCase();
  document.getElementById("t2score").textContent=(await read(MATCH+"/T2Score.txt")).trim()||"0";
  const c = hex((await read(MATCH+"/T2Color.txt")).trim()) || "#C80013";
  document.documentElement.style.setProperty("--t2", c);
  const rgb = hexToRgb(c) || [200,0,19];
  document.documentElement.style.setProperty("--t2-rgb", rgb.join(","));
  if(await ok(MATCH+"/T2Logo.png")) setBg(document.getElementById("t2logo"), MATCH+"/T2Logo.png");
  else document.getElementById("t2logo").style.backgroundImage="none";
}
function toggleScoreBoxes(){
  const a=(document.getElementById("t1score").textContent||"0").trim();
  const b=(document.getElementById("t2score").textContent||"0").trim();
  const show=(parseInt(a,10)||0)!==0 || (parseInt(b,10)||0)!==0;
  document.getElementById("t1scorebox").style.display=show?"flex":"none";
  document.getElementById("t2scorebox").style.display=show?"flex":"none";
}

/* ----- Draft rendering ----- */
async function renderDraft(){
  const state = await readJSON(MATCH + "/match.json");
  const mapsManifest  = await readJSON(SB + "/Maps/index.json");
  const mapsBySlug = bySlug(mapsManifest.maps || []);

  const root = document.getElementById("draftArea");
  root.innerHTML = "";

  const maps = (state.maps || []).filter(m => (m.map || "").trim());
  if(!maps.length){
    root.innerHTML = '<div class="empty-note">Ei valittuja karttoja.</div>';
    return;
  }

  const undecided = maps
    .map((m, idx) => ({ idx, pick: ((m.pick || "") + "").trim().toUpperCase() }))
    .filter(x => !(x.pick === "T1" || x.pick === "T2" || x.pick === "TEAM 1" || x.pick === "TEAM 2"));
  const deciderIdx = undecided.length ? undecided[undecided.length - 1].idx : -1;

  root.style.gridTemplateColumns = `repeat(${maps.length}, minmax(0, 1fr))`;

  maps.forEach((m, idx)=>{
    const col = document.createElement("div");
    col.className = "draft-col";

    const mapName = (m.map || "").trim();
    const meta = mapsBySlug[nameToSlug(mapName)] || {};
    const mapImagePath = resolveMapImagePath(meta, mapName);

    const pickRaw = ((m.pick || "") + "").trim().toUpperCase();
    let pick = pickRaw;
    if (pick === "TEAM 1") pick = "T1";
    if (pick === "TEAM 2") pick = "T2";

    const action = idx === deciderIdx ? "DECIDER" : (pick === "T1" || pick === "T2" ? "PICK" : "BAN");
    const card = document.createElement("div");
    card.className = `map-card ${action.toLowerCase()}`;
    card.style.backgroundImage = `url('${mapImagePath}?_=${Date.now()}')`;

    const winner = ((m.winner || "") + "").toLowerCase();
    const logoTeam = action === "PICK" ? pick : (action === "BAN" ? ((idx % 2 === 0) ? "T1" : "T2") : "");

    if (winner === "t1" || winner === "t2") {
      const rgbVar = getComputedStyle(document.documentElement)
        .getPropertyValue(winner === "t1" ? "--t1-rgb" : "--t2-rgb").trim() || "255,255,255";
      card.style.setProperty("--winner-rgb", rgbVar);
      card.classList.add(winner === "t1" ? "winner-t1" : "winner-t2");
    }

    const center = document.createElement("div");
    center.className = "winner-center";

    if (winner === "t1" || winner === "t2") {
      const img = document.createElement("img");
      img.src = `${MATCH}/${winner.toUpperCase()}Logo.png?_=${Date.now()}`;
      img.alt = winner.toUpperCase();
      center.appendChild(img);
    } else if (logoTeam) {
      const img = document.createElement("img");
      img.className = "action-logo";
      img.src = `${MATCH}/${logoTeam}Logo.png?_=${Date.now()}`;
      img.alt = logoTeam;
      center.appendChild(img);
    }

    card.appendChild(center);

    const metaEl = document.createElement("div");
    metaEl.className = "card-meta";
    metaEl.innerHTML = `<div class="action-tag">${action}</div><div class="map-name">${mapName.toUpperCase()}</div>`;

    col.appendChild(card);
    col.appendChild(metaEl);
    root.appendChild(col);
  });
}


let _prevSig=null;
async function tick(){
  try{
    const [pool, t1n,t2n,t1s,t2s,t1c,t2c, state] = await Promise.all([
      read(MATCH+"/maps.txt"),
      read(MATCH+"/T1Name.txt"), read(MATCH+"/T2Name.txt"),
      read(MATCH+"/T1Score.txt"), read(MATCH+"/T2Score.txt"),
      read(MATCH+"/T1Color.txt"), read(MATCH+"/T2Color.txt"),
      readJSON(MATCH+"/match.json"),
    ]);

    const b1 = (state.team1?.banned_hero || "").trim();
    const b2 = (state.team2?.banned_hero || "").trim();

    const mapsSig = JSON.stringify((state.maps||[]).map(m=>({
      map:m.map, completed:!!m.completed, winner:(m.winner||""), pick:(m.pick||""), mode:(m.mode||"")
    })));
    const bansSig = JSON.stringify((state.maps||[]).map(m=>[m.t1_ban||"", m.t2_ban||""]));
	const sig = [pool,t1n,t2n,t1s,t2s,t1c,t2c,mapsSig,bansSig].join("|");


    if(sig!==_prevSig){
      _prevSig=sig;
      await applyColors();
      await Promise.all([upT1(), upT2()]);
      toggleScoreBoxes();
      await renderDraft();
    }
	upStatusText().catch(()=>{});
    await renderCornerBans(state);

  }finally{
    setTimeout(tick, 1000);
  }
}


tick();
</script>
</body>
</html>
