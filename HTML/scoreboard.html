<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>SOW Scoreboard</title>
<style>
  @font-face{font-family:'Rajdhani';src:url("fonts/Rajdhani/Rajdhani-Bold.ttf") format('TrueType');font-weight:bold}
  @font-face{font-family:'Rajdhani';src:url("fonts/Rajdhani/Rajdhani-Regular.ttf") format('TrueType');font-weight:normal}
  html,body{margin:0;padding:0;width:1920px;height:1080px;background:rgba(0,0,0,0);overflow:hidden;font-family:'Rajdhani',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif}

	:root{
	  --primary:#0f1114;
	  --secondary:#000000;
	  --text:#ffffff;
	  --t1:#27AAE1;
	  --t2:#C80013;
	  --quaternary:#3A3A90;
	}
	
.maptop{
  position:fixed; top:0px; left:50%; transform:translateX(-50%);
  height:28px;
  display:inline-flex;
  align-items:stretch;
  background:var(--primary);
  border:1px solid rgba(0,0,0,.25);
  border-radius:6px;
  overflow:hidden;
  box-shadow:0 6px 18px rgba(0,0,0,.25);
  pointer-events:none;
}

.mapbar{ height:30px; display:flex; align-items:stretch; }

.pickbox{
  height:30px; width:136px; padding:0 12px;
  display:none;
  align-items:center;
  justify-content:center;
  gap:8px;
  background:var(--primary);
  color:var(--text);
  font:800 26px/1 Rajdhani;
  letter-spacing:.5px;
  text-transform:uppercase;
  border-left:1px solid rgba(0,0,0,.25);
}
.pickbox .ico{ width:26px; height:26px; background-size:contain; background-repeat:no-repeat; background-position:center; }

.seg{
  height:30px; width:136px; padding:0 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  background:var(--primary);
  color:var(--text);
  font:800 26px/1 Rajdhani;
  letter-spacing:.5px;
  text-align:center;
}
.seg.empty{ background:transparent; color:var(--text); align-items:center;}
.seg.current{ background:transparent; color:var(--text); align-items:center;}
.seg.done{ background:transparent; color:var(--text); align-items:center;}
.seg .ico{ width:26px; height:26px; background-size:contain; background-repeat:no-repeat; background-position:center;}

.card{
  position:fixed; top:10px; width:446px; height:55px;
  background:var(--primary); color:var(--text);
  border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,.28);
  display:block;
}
.card.left  { left:43px; padding-left:78px;  }
.card.right { right:43px; padding-right:78px; }

.card .inner{
  position:relative;
  height:100%;
  display:flex;
  align-items:center;
  gap:12px;
}
.card .inner.left  { justify-content:flex-start; text-align:right; }
.card .inner.left .name { text-align:right; }

.card .inner.right { justify-content:flex-end; }

.card .name{
  flex:1 1 0%;
  min-width:0;
  font-size:32px;
  font-weight:800;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  text-transform:uppercase;
  letter-spacing: -1px;
}
.card .logo{
  flex:0 0 56px;
  flex-shrink:0;
  width:56px;
  height:100%;
  background-size:contain;
  background-repeat:no-repeat;
  background-position:center;
}
.card.left  .logo{  background-color: var(--t1); }
.card.right .logo{  background-color: var(--t2); }

.card .score{
  flex:0 0 27px;
  flex-shrink:0;
  height:100%;
  padding:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:32px;
  font-weight:900;
  background:transparent;
  text-align:center;
}

.card.left  .inner{ padding-right:12px; }
.card.right .inner{ padding-left:12px;  }

.ban{
  position:absolute; top:50%; transform:translateY(-50%);
  width:56px; height:100%;
  background-size:cover; background-position:center; background-repeat:no-repeat;
  display:none;
  box-shadow:none; outline:none; border:none;
}
.card.left  .ban{ left:4px;}
.card.right .ban{ right:4px;}

.ban.has-ban::after{
  content:"BAN";
  position:absolute;
  top:4px; bottom:4px;
  display:flex; align-items:center; justify-content:center;
  writing-mode:vertical-rl; text-orientation:upright;
  font:900 17px/1 'Rajdhani', sans-serif;
  letter-spacing:-5px;
}

.card.left  .ban.has-ban::after{  right:-18px; color:var(--t1); }
.card.right .ban.has-ban::after{  left:-18px;  color:var(--t2); }

.card, .maptop { 
  will-change: transform, opacity; 
  transition: transform 2080ms cubic-bezier(.2,.8,.2,1), opacity 2000ms ease;
}

body:not(.visible) .maptop,
body.leaving      .maptop { transform: translate(-50%,-24px); opacity:0; }

body:not(.visible) #t1card, body:not(.visible) .card.left,
body.leaving      #t1card, body.leaving      .card.left { transform: translateX(-40px); opacity:0; }

body:not(.visible) #t2card, body:not(.visible) .card.right,
body.leaving      #t2card, body.leaving      .card.right{ transform: translateX(40px);  opacity:0; }

.ban{ transition: transform 2000ms ease, opacity 2000ms ease; }
body:not(.visible) .ban,
body.leaving      .ban { opacity:0; transform: translateY(-50%) scale(.9); }
</style>
</head>
<body>
  <div class="maptop" id="maptop">
    <div class="mapbar" id="mapbar"></div>
    <div class="pickbox" id="pickbox">
      <div class="ico" id="pickico"></div>
      <span id="pickabbr"></span>
      <span>PICK</span>
    </div>
  </div>
	<div class="card left" id="t1card">
	  <div class="ban" id="t1ban"></div>
	  <div class="inner left">
		<div class="name"  id="t1name">TEAM 1</div>
		<div class="logo"  id="t1logo"></div>
		<div class="score" id="t1score">0</div>
	  </div>
	</div>
	<div class="card right" id="t2card">
	  <div class="ban" id="t2ban"></div>
	  <div class="inner right">
		<div class="score" id="t2score">0</div>
		<div class="logo"  id="t2logo"></div>
		<div class="name"  id="t2name">TEAM 2</div>
	  </div>
	</div>
<script>
  const ROOT="..", SB=ROOT+"/Scoreboard", MATCH=SB+"/Match", GENERAL=SB+"/General", HEROES=SB+"/Heroes";

  async function read(p){ try{ const r=await fetch(p+"?_="+Date.now()); return r.ok?await r.text():""; }catch{ return ""; } }
  async function headOK(p){ try{ const r=await fetch(p+"?_="+Date.now(),{method:"HEAD"}); return r.ok; }catch{ return false; } }
  const hex = (s,f)=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test((s||"").trim())?(s||"").trim():(f||"#000");
  const slug = s=>(s||"").toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item";
  const setBg = (el,url)=>el.style.backgroundImage=`url('${url}?_=${Date.now()}')`;

  let T1_LOGO = MATCH+"/T1Logo.png";
  let T2_LOGO = MATCH+"/T2Logo.png";
  
  let T1_ABBR = "", T2_ABBR = "";

async function upT1Abbr(){
  T1_ABBR = (await read(MATCH + "/T1Abbr.txt")).trim();
}
async function upT2Abbr(){
  T2_ABBR = (await read(MATCH + "/T2Abbr.txt")).trim();
}

async function readCurrentMapKV(){
  const cur = parseInt((await read(MATCH + "/CurrentMap.txt")).trim(), 10) || 0;
  if (!cur) return null;
  const path = `${MATCH}/Map${cur}.txt`;
  if (!(await headOK(path))) return null;

  const kv = {};
  (await read(path)).split(/\r?\n/).forEach(line=>{
    const m = line.match(/^\s*([^=#]+)\s*=\s*(.+?)\s*$/);
    if(m) kv[m[1].trim()] = m[2].trim();
  });
  return kv;
}

async function applyColors(){
  const kv={}; (await read(GENERAL+"/colors.txt")).split(/\r?\n/).forEach(l=>{
    const m=l.match(/^\s*([^=#]+)\s*=\s*(.+?)\s*$/); if(m) kv[m[1].trim()]=m[2].trim();
  });
  document.documentElement.style.setProperty("--primary",    hex(kv.primary,"#0f1114"));
  document.documentElement.style.setProperty("--tertiary",    hex(kv.tertiary,"#55aaff"));
  document.documentElement.style.setProperty("--text",       hex(kv.secondary,"#ffffff"));
  document.documentElement.style.setProperty("--quaternary", hex(kv.quaternary,"#3A3A90"));
}

  async function upT1Name(){ document.getElementById("t1name").textContent=(await read(MATCH+"/T1Name.txt")).trim()||"TEAM 1"; }
  async function upT1Score(){ document.getElementById("t1score").textContent=(await read(MATCH+"/T1Score.txt")).trim()||"0"; }
  async function upT1Color(){ const c=hex((await read(MATCH+"/T1Color.txt")).trim(),"#27AAE1"); document.documentElement.style.setProperty("--t1", c); document.getElementById("t1card").style.borderRightColor=c; }
  async function upT1Logo(){
    T1_LOGO = MATCH+"/T1Logo.png";
    if(await headOK(T1_LOGO)){ setBg(document.getElementById("t1logo"), T1_LOGO); }
    else{ document.getElementById("t1logo").style.backgroundImage="none"; }
  }
  
	async function upT1Ban(){
	  const el  = document.getElementById("t1ban");
	  let shown = false;

	  const kv = await readCurrentMapKV();
	  const hero = (kv?.T1Ban || "").trim();

	  if (hero){
		const p = HEROES + "/" + slug(hero) + ".png";
		if (await headOK(p)){ setBg(el, p); el.style.display = "block"; shown = true; }
	  }
	  if (!shown){
		el.style.display = "none";
		el.style.backgroundImage = "none";
	  }
	  el.classList.toggle("has-ban", shown);
	}

  async function upT2Name(){ document.getElementById("t2name").textContent=(await read(MATCH+"/T2Name.txt")).trim()||"TEAM 2"; }
  async function upT2Score(){ document.getElementById("t2score").textContent=(await read(MATCH+"/T2Score.txt")).trim()||"0"; }
  async function upT2Color(){ const c=hex((await read(MATCH+"/T2Color.txt")).trim(),"#C80013"); document.documentElement.style.setProperty("--t2", c); document.getElementById("t2card").style.borderLeftColor=c; }
  async function upT2Logo(){
    T2_LOGO = MATCH+"/T2Logo.png";
    if(await headOK(T2_LOGO)){ setBg(document.getElementById("t2logo"), T2_LOGO); }
    else{ document.getElementById("t2logo").style.backgroundImage="none"; }
  }
	async function upT2Ban(){
	  const el  = document.getElementById("t2ban");
	  let shown = false;

	  const kv = await readCurrentMapKV();
	  const hero = (kv?.T2Ban || "").trim();

	  if (hero){
		const p = HEROES + "/" + slug(hero) + ".png";
		if (await headOK(p)){ setBg(el, p); el.style.display = "block"; shown = true; }
	  }
	  if (!shown){
		el.style.display = "none";
		el.style.backgroundImage = "none";
	  }
	  el.classList.toggle("has-ban", shown);
	}

async function upMaps(){
  const bar = document.getElementById("mapbar");
  const n = parseInt((await read(GENERAL + "/first_to.txt")).trim(), 10) || 3;
  const count = Math.max(1, Math.min(7, n));
  let current = parseInt((await read(MATCH + "/CurrentMap.txt")).trim(), 10) || 1;

  // Clamp to a sensible range
  if (current < 1) current = 1;
  if (current > count) current = count;

  bar.innerHTML = "";

  const seg = document.createElement("div");
  seg.className = "seg current";

  const txt = document.createElement("span");
  txt.textContent = `MAP ${current}/${count}`;

  seg.append(txt);
  bar.appendChild(seg);
}

async function upPickBox(){
  const box = document.getElementById("pickbox");
  const ico = document.getElementById("pickico");
  const ab  = document.getElementById("pickabbr");

  const kv = await readCurrentMapKV();
  const pickRaw = (kv?.Pick || "").trim().toUpperCase();
  const pick = (pickRaw === "T1" || pickRaw === "TEAM 1") ? "T1"
             : (pickRaw === "T2" || pickRaw === "TEAM 2") ? "T2" : "";

  if (!pick){
    box.style.display = "none";
ico.style.backgroundImage = "none";
    ab.textContent = "";
    return;
  }

  const logo = (pick === "T1") ? T1_LOGO : T2_LOGO;
  const abbr = (pick === "T1") ? (T1_ABBR || "T1") : (T2_ABBR || "T2");

  ico.style.backgroundImage = `url('${logo}?_=${Date.now()}')`;
  ab.textContent = abbr.toUpperCase();
box.style.display = "flex";
}

async function initial(){
  await applyColors();
	await Promise.all([
	  upT1Name(), upT1Score(), upT1Color(), upT1Logo(),
	  upT2Name(), upT2Score(), upT2Color(), upT2Logo(),
	  upT1Abbr(), upT2Abbr()
	]);
	await upMaps();
	await upPickBox();
	await upT1Ban();
	await upT2Ban();			   
}


  function startSSE(){
    const es=new EventSource("/events");
    es.onmessage=async ev=>{
      try{
        const d=JSON.parse(ev.data||"{}"); const ch=Array.isArray(d.changed)?d.changed:[];
        for(const k of ch){
          if(k==="general.colors") await applyColors();
			else if(k==="general.first_to"){ await upMaps(); await upPickBox(); await upT1Ban(); await upT2Ban(); }
			else if(k==="maps"){ await upMaps(); await upPickBox(); await upT1Ban(); await upT2Ban(); }
          else if(k==="t1.name") await upT1Name();
          else if(k==="t1.score") await upT1Score();
          else if(k==="t1.color") await upT1Color();
			else if(k==="t1.logo"){ await upT1Logo(); await upPickBox(); }
          else if(k==="t2.name") await upT2Name();
          else if(k==="t2.score") await upT2Score();
          else if(k==="t2.color") await upT2Color();
			else if(k==="t2.logo"){ await upT2Logo(); await upPickBox(); }
			else if(k==="t1.abbr"){ await upT1Abbr(); await upPickBox(); }
			else if(k==="t2.abbr"){ await upT2Abbr(); await upPickBox(); }
		  else handleOverlayKey(k);
        }
      }catch{}
    };
  }

  (async()=>{ await initial(); startSSE(); })();
function setOverlayVisible(v){
  document.body.classList.toggle('visible', !!v);
  document.body.classList.toggle('leaving', !v);
}

function getStingerStartMs(){
  const qs = new URLSearchParams(location.search);
  const q  = parseInt(qs.get("stinger") || qs.get("delay") || "", 10);
  if(!isNaN(q) && q >= 0) return q;
  return 1800;
}

document.addEventListener("DOMContentLoaded", ()=>{
  const delay = getStingerStartMs();
  setTimeout(()=> setOverlayVisible(true), delay);
});

document.addEventListener("visibilitychange", ()=>{
  setOverlayVisible(!document.hidden);
});

function handleOverlayKey(k){
  if(k==="overlay.scoreboard.show") setOverlayVisible(true);
  if(k==="overlay.scoreboard.hide") setOverlayVisible(false);
}
</script>
</body>
</html>
