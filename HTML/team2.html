<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Roster Overlay â€” Team 2</title>
  <style>
    :root{
      --wrap-w:1920px;
      --pad-x:48px;
      --pad-y:28px;
      --gap:32px;
      --card-r:24px;
      --card-p:22px;
      --avatar:168px;
      --ico:27px;
      --label:21px;
      --value:30px;
    }

    :root { --bg:#3f0f18; --card:rgba(255,255,255,.06); --muted:#ffd2dd; --text:#fff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}

    .wrap{width:var(--wrap-w); margin:0 auto; padding:var(--pad-y) var(--pad-x);}
    .title{font-size:64px;font-weight:900;line-height:1.05;margin:0 0 6px;letter-spacing:.02em}
    .subtitle{font-size:30px;font-weight:600;opacity:.9;margin:0 0 20px;min-height:1.2em}
    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:var(--gap)}
    .card{background:var(--card);border-radius:var(--card-r);padding:var(--card-p);text-align:center;backdrop-filter:blur(6px)}
    .avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover;background:#fff;margin:0 auto 12px}
    .nick{font-size:36px;font-weight:800;margin-bottom:6px}
    .label{color:var(--muted);letter-spacing:.08em;font-size:var(--label)}
    .val{font-weight:700;font-variant-numeric:tabular-nums;font-size:var(--value)}

    .valbox{ position:relative; min-height:1.4em; display:block; }
    .valbox .valtext{ display:inline-block; position:relative; left:50%; transform:translateX(-50%); }

    .valbox.r-good  .valtext::after,
    .valbox.r-okay  .valtext::after,
    .valbox.r-bad   .valtext::after{
      content:""; position:absolute; top:50%; left:100%;
      transform: translate(8px,-50%);
      width:var(--ico); height:var(--ico); background-size:contain; background-repeat:no-repeat;
    }
    .valbox.r-good  .valtext::after{ background-image:url("images/good.png"); }
    .valbox.r-okay  .valtext::after{ background-image:url("images/okay.png"); }
    .valbox.r-bad   .valtext::after{ background-image:url("images/bad.png"); }

    .kv{display:grid;grid-template-columns:auto auto;gap:6px 36px;justify-content:center;align-items:center}
    .status{margin-top:8px;opacity:.7;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="title" class="title">Statistics</h1>
    <h2 id="subtitle" class="subtitle"></h2>
    <div id="grid" class="grid"></div>
    <div id="status" class="status"></div>
  </div>

  <script>
    const TEAM_OFFSET = 5;
    const TEAM_SIZE = 5;

    const API_BASE = (location.origin === 'null' || location.protocol === 'file:') ? 'http://localhost:8787' : '';

    const qs = new URLSearchParams(location.search);
    const KD_GOOD  = Number(qs.get('kd_good'))  || 1.20;
    const KD_OK    = Number(qs.get('kd_ok'))    || 0.95;
    const ADR_GOOD = Number(qs.get('adr_good')) || 85;
    const ADR_OK   = Number(qs.get('adr_ok'))   || 65;
    const HS_GOOD  = Number(qs.get('hs_good'))  || 45;
    const HS_OK    = Number(qs.get('hs_ok'))    || 35;

    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const grid = document.getElementById('grid');
    const statusEl = document.getElementById('status');

    const rateKD  = v => (v==null||isNaN(v))?null:(v>=KD_GOOD?'good':(v>=KD_OK?'okay':'bad'));
    const rateADR = v => (v==null||isNaN(v))?null:(v>=ADR_GOOD?'good':(v>=ADR_OK?'okay':'bad'));
    const rateHS  = v => (v==null||isNaN(v))?null:(v>=HS_GOOD?'good':(v>=HS_OK?'okay':'bad'));

    const valOnly = t => `<span class="valtext">${t ?? '-'}</span>`;
    const boxClass = r => r ? ` valbox r-${r}` : ' valbox';

    const AGENTS = [
      'assets/agents/agent6.png',
      'assets/agents/agent7.png',
      'assets/agents/agent8.png',
      'assets/agents/agent9.png',
      'assets/agents/agent10.png',
    ];

    const toNumber = (value) => {
      if (value == null || value === '') return null;
      if (typeof value === 'number') return Number.isFinite(value) ? value : null;
      const cleaned = String(value).replace('%','').replace(',','.').trim();
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : null;
    };

    const pick = (obj, keys) => {
      for (const key of keys) {
        if (obj && obj[key] != null && obj[key] !== '') return obj[key];
      }
      return null;
    };

    const fromStats = (player, keys) => pick(player?.stats || {}, keys);

    function normalizePlayer(player){
      const nickname = pick(player, ['nickname','nick','name','player_name','playerName']) || '-';

      const killsRaw = pick(player, ['kills','kill','k']) ?? fromStats(player, ['kills','kill','k']);
      const deathsRaw = pick(player, ['deaths','death','d']) ?? fromStats(player, ['deaths','death','d']);
      const kdRaw = pick(player, ['kd','kdr','kd_ratio','k_d']) ?? fromStats(player, ['kd','kdr','kd ratio','k/d']);
      const adrRaw = pick(player, ['adr','average_damage_per_round','damage_per_round']) ?? fromStats(player, ['adr','average_damage_per_round','damage per round']);
      const hsRaw = pick(player, ['hs_pct','hs','headshot_pct','headshot_percentage']) ?? fromStats(player, ['hs%','headshots %','headshot %','headshot_percentage']);

      const kills = toNumber(killsRaw);
      const deaths = toNumber(deathsRaw);
      const kd = toNumber(kdRaw);
      const adr = toNumber(adrRaw);
      const hsParsed = toNumber(hsRaw);
      const hs_pct = (hsParsed != null && hsParsed <= 1) ? hsParsed * 100 : hsParsed;

      return { nickname, kills, deaths, kd, adr, hs_pct };
    }

    function extractPlayers(payload){
      if (Array.isArray(payload?.players)) return payload.players.map(normalizePlayer);

      if (payload?.team1?.players || payload?.team2?.players) {
        const t1 = Array.isArray(payload?.team1?.players) ? payload.team1.players : [];
        const t2 = Array.isArray(payload?.team2?.players) ? payload.team2.players : [];
        return [...t1, ...t2].map(normalizePlayer);
      }

      if (Array.isArray(payload?.teams)) {
        const flattened = payload.teams.flatMap(team => Array.isArray(team?.players) ? team.players : []);
        return flattened.map(normalizePlayer);
      }

      return [];
    }

    function cardHTML(p, idx){
      const kd  = (p.kd  != null) ? Number(p.kd).toFixed(2) : '-';
      const adr = (p.adr != null) ? Number(p.adr).toFixed(2) : '-';
      const hs  = (p.hs_pct != null) ? Number(p.hs_pct).toFixed(0) : '-';
      const avatarSrc = AGENTS[idx] || AGENTS[0];

      return `<div class="card">
        <img class="avatar" src="${avatarSrc}" alt="">
        <div class="nick">${p.nickname ?? '-'}</div>
        <div class="kv">
          <div class="label">KILLS</div><div class="val${boxClass(null)}">${valOnly(p.kills ?? '-')}</div>
          <div class="label">DEATHS</div><div class="val${boxClass(null)}">${valOnly(p.deaths ?? '-')}</div>
          <div class="label">K/D</div><div class="val${boxClass(rateKD(Number(p.kd)))}">${valOnly(kd)}</div>
          <div class="label">ADR</div><div class="val${boxClass(rateADR(Number(p.adr)))}">${valOnly(adr)}</div>
          <div class="label">HS%</div><div class="val${boxClass(rateHS(Number(p.hs_pct)))}">${valOnly(hs)}</div>
        </div>
      </div>`;
    }

    async function refreshOnce(){
      try{
        const r = await fetch(API_BASE + '/render', { cache:'no-store' });
        if(!r.ok) throw new Error(await r.text());
        const js = await r.json();
        const allPlayers = extractPlayers(js);
        const players = allPlayers.slice(TEAM_OFFSET, TEAM_OFFSET + TEAM_SIZE);

        const statsCfg = js.statistics || {};
        const title = (statsCfg.title || 'Statistics').toString().trim() || 'Statistics';
        const subtitle = (statsCfg.subtitle || '').toString();
        titleEl.textContent = title;
        subtitleEl.textContent = subtitle;
        subtitleEl.style.display = subtitle.trim() ? 'block' : 'none';
        grid.innerHTML = '';
        if(players.length === 0){
          statusEl.textContent = 'No player stats yet. Load tournament data in tool.';
          return;
        }
        players.forEach((p, i) => grid.insertAdjacentHTML('beforeend', cardHTML(p, i)));
        statusEl.textContent = '';
      }catch(e){
        statusEl.textContent = 'Connection error: ' + e.message;
      }
    }

    refreshOnce();

    try{
      const es = new EventSource(API_BASE + '/events');
      es.addEventListener('update', () => { refreshOnce(); });
      es.onmessage = () => { refreshOnce(); };
    }catch(e){
      statusEl.textContent = 'SSE not supported in this environment.';
    }
  </script>
</body>
</html>
